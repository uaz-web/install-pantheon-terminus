name: 'Install Pantheon Terminus'
description: "Install Terminus, Pantheon's CLI tool."
inputs:
  terminus-version:
    description: 'A specific version of Terminus to install. (x.y.z)'
    default: 'latest'
    required: false
    type: string
  pantheon-machine-token:
    description: 'A machine token for Terminus generated by Pantheon.'
    required: true
    type: string
  setup-ssh:
    description: 'Determine whether or not to setup an SSH key with Pantheon.'
    required: false
    default: false
    type: boolean
  pantheon-ssh-key:
    description: 'An SSH key to setup on Pantheon.'
    required: false
    type: string
runs:
  using: "composite"
  steps:
  
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '7.4'
        
    - name: Download and install Terminus
      run: |
        echo "Installing Terminus version: ${{ inputs.terminus-version }}"
        mkdir -p ~/terminus && cd ~/terminus
        curl -L https://github.com/pantheon-systems/terminus/releases/download/"${{ inputs.terminus-version }}"/terminus.phar --output terminus
        chmod +x terminus
        sudo ln -s ~/terminus/terminus /usr/local/bin/terminus
      shell: bash
      
    - name: Authenticate with Pantheon machine token
      run: terminus auth:login --machine-token="${{ inputs.pantheon-machine-token }}"
      shell: bash
      
    - name: Setup SSH
      if: ${{ inputs.setup-ssh == 'true' }}
      run: |
        echo "Setting up SSH key"
        mkdir ${HOME}/.ssh && chmod 700 ${HOME}/.ssh
        echo -e "Host *.drush.in\n    StrictHostKeyChecking no\n    HostkeyAlgorithms +ssh-rsa" > ${HOME}/.ssh/config
        echo "${{ inputs.pantheon-ssh-key }}" > ${HOME}/.ssh/id_rsa
        chmod 600 ${HOME}/.ssh/*
      shell: bash
